import { parseAst, generateFromAst, logDiff } from "@tanstack/router-utils";
import { getConfig } from "./config.js";
import { routeHmrStatement } from "./route-hmr-statement.js";
import { debug } from "./utils.js";
const unpluginRouterHmrFactory = (options = {}) => {
  let ROOT = process.cwd();
  return {
    name: "tanstack-router:hmr",
    enforce: "pre",
    transform: {
      filter: {
        code: "createFileRoute("
      },
      handler(code, id) {
        var _a;
        if (!((_a = globalThis.TSR_ROUTES_BY_ID_MAP) == null ? void 0 : _a.has(id))) {
          return null;
        }
        if (debug) console.info("Adding HMR handling to route ", id);
        const ast = parseAst({ code });
        ast.program.body.push(routeHmrStatement);
        const result = generateFromAst(ast, {
          sourceMaps: true,
          filename: id,
          sourceFileName: id
        });
        if (debug) {
          logDiff(code, result.code);
          console.log("Output:\n", result.code + "\n\n");
        }
        return result;
      }
    },
    vite: {
      configResolved(config) {
        ROOT = config.root;
        getConfig(options, ROOT);
      }
    },
    rspack() {
      ROOT = process.cwd();
      getConfig(options, ROOT);
    },
    webpack() {
      ROOT = process.cwd();
      getConfig(options, ROOT);
    }
  };
};
export {
  unpluginRouterHmrFactory
};
//# sourceMappingURL=router-hmr-plugin.js.map
